pipeline {
    agent any
    
    environment {
        // Define Maven home path
        def mavenHome = tool name: 'maven3.9.7', type: 'maven'
    }
    
    stages {
        stage('Clone Code') {
            steps {
                // Clone the repository
                git "https://github.com/lovelyleti20/maven-web-application"
            }
        }
        
        stage('Build with Maven') {
            steps {
                // Build the Maven project
                sh "${mavenHome}/bin/mvn package"
            }
        }
        
        stage('Code Quality Analysis') {
            steps {
                // Run SonarQube analysis
                sh "${mavenHome}/bin/mvn sonar:sonar"
            }
        }
        
        stage('Upload Artifacts') {
            steps {
                // Deploy artifacts (replace 'deploy' with your actual deployment step)
                sh "${mavenHome}/bin/mvn deploy"
            }
        }
        
        stage('Deploy to UAT') {
            steps {
                // Deploy to UAT environment (adjust as per your deployment method)
                deploy adapters: [tomcat9(credentialsId: 'tomcatuser2', path: '', url: 'http://172.31.23.206:8088/')], contextPath: '', war: '**/*.war'
            }
        }
        
        stage('Manual Approval') {
            steps {
                // Wait for manual approval
                timeout(time: 300, unit: 'MINUTES') {
                    input message: 'Application ready for deployment. Please review and approve.'
                }
            }
        }
        
        stage('Deploy to Production') {
            steps {
                // Deploy to production environment (adjust as per your deployment method)
                deploy adapters: [tomcat9(credentialsId: 'tomcatuser2', path: '', url: 'http://172.31.23.206:8088/')], contextPath: '', war: '**/*.war'
            }
        }
    }
    
    post {
        always {
            // Send email notification on build completion
            emailext body: '''Hi Team,

Build status.

Landmark Technologies.
Tel: +1 437 215 2483
''', recipientProviders: [buildUser(), developers(), contributor()], subject: 'Build status', to: 'mylandmarktech@gmail.com'
        }
        
        success {
            // Send success email notification
            emailext body: '''Hi Team,

Build succeeded.

Landmark Technologies.
Tel: +1 437 215 2483
''', recipientProviders: [buildUser(), developers(), contributor()], subject: 'Build succeeded', to: 'mylandmarktech@gmail.com'
        }
        
        failure {
            // Send failure email notification
            emailext body: '''Hi Team,

Build failed.

Landmark Technologies.
Tel: +1 437 215 2483
''', recipientProviders: [buildUser(), developers(), contributor()], subject: 'Build failed', to: 'mylandmarktech@gmail.com'
        }
    }
}
